import{_ as s,Q as a,a3 as t,a6 as p,a4 as n,a5 as e,a7 as o}from"./framework-94ca7993.js";const l={},c=n("h1",{id:"spring-boot-工程-jar-包瘦身",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#spring-boot-工程-jar-包瘦身","aria-hidden":"true"},"#"),e(" spring boot 工程 jar 包瘦身")],-1),i=n("p",null,"Spring Boot项目的pom.xml文件中一般都会带有spring-boot-maven-plugin插件，该插件的作用就是会将依赖的jar包全部打包进去。 但是该文件包含了所有的依赖和资源文件，会导致打出来的包会比较大。",-1),u=n("p",null,"而如果我们使用一般的打包命令时",-1),g=n("div",{class:"language-bash","data-ext":"sh"},[n("pre",{class:"language-bash"},[n("code",null,`mvn clean package
`)])],-1),r=n("p",null,"不会把依赖的jar包也打进去，这样打出来的包就会很小。",-1),k=o(`<h2 id="问题描述" tabindex="-1"><a class="header-anchor" href="#问题描述" aria-hidden="true">#</a> 问题描述</h2><p>但当一个系统上线运行后，肯定会有需求迭代和Bug修复，那也就免不了进行重新打包部署。</p><p>此时有一个场景：线上有一个紧急BUG,并且BUG很快被定位并且修复，其实就是一行代码的事情，现在代码修改好了并且完成了构建然后开始打包交付时发现，jar包很大，一直在上传。</p><p>而当经常需要迭代发布，每一次都上传一个庞大的jar包文件，会浪费很多时间。</p><p>此时就需要为jar包瘦瘦身，降低jar包文件的大小。</p><h2 id="瘦身原理" tabindex="-1"><a class="header-anchor" href="#瘦身原理" aria-hidden="true">#</a> 瘦身原理</h2><p>一个spring boot正常的打包，包含所有依赖时打出的jar包有120多M:</p><p>解压查看内部有三个包，<strong>BOOT-INF</strong>、<strong>META-INFO</strong>、<strong>org</strong><img src="https://qiniu.yanggl.cn/image/20230621141023255.png" alt="img.png" loading="lazy"></p><p>打开BOOT-INF <img src="https://qiniu.yanggl.cn/image/20230621141102321.png" alt="img_1.png" loading="lazy"></p><ul><li><strong>classes：</strong> 存放当前项目编译好的代码，这部分是非常小的。</li><li><strong>lib：</strong> 存放我们所依赖的 jar 包,lib部分会很大。</li></ul><h3 id="原理" tabindex="-1"><a class="header-anchor" href="#原理" aria-hidden="true">#</a> 原理</h3><p>当一个项目的依赖越多，lib包就会越大。虽然依赖多，但是当版本迭代稳定之后，依赖基本就不会再变动了。</p><p>我们就可以把这些不变的依赖提前都放到服务器上，打包的时候忽略这些依赖，只打本项目编译好的文件，这样打出来的jar包就会很小，提高发版效率。</p><h3 id="配置实现" tabindex="-1"><a class="header-anchor" href="#配置实现" aria-hidden="true">#</a> 配置实现</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- 设置主函数 --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>cn.yanggl.xxxMain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span><span class="token punctuation">&gt;</span></span>ZIP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!--这里是填写需要包含进去的jar，
                     必须项目中的某些模块，会经常变动，那么就应该将其坐标写进来
                     如果没有则nothing ，表示不打包依赖 --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token comment">&lt;!-- 需要一起打包到项目jar包的依赖 --&gt;</span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>nothing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>nothing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--拷贝依赖到jar外面的lib目录--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-dependency-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>copy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>copy-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                        <span class="token comment">&lt;!-- 指定依赖导出位置 --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>\${project.build.directory}/lib<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>overWriteReleases</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>overWriteReleases</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>overWriteSnapshots</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>overWriteSnapshots</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>overWriteIfNewer</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>overWriteIfNewer</span><span class="token punctuation">&gt;</span></span>
                        <span class="token comment">&lt;!--  不需要导出的依赖 --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludeArtifactIds</span><span class="token punctuation">&gt;</span></span>
                            cn.yanggl
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludeArtifactIds</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调整了配置之后，再次打包我们会发现发现target目录中多了个lib文件夹，里面保存了所有的依赖jar。本项目的jar包只有几百K。</p><blockquote><p>当include标签只填groupId标签时，表示groupId标识下的所有依赖都包含</p></blockquote><h3 id="问题" tabindex="-1"><a class="header-anchor" href="#问题" aria-hidden="true">#</a> 问题</h3><h4 id="启动问题" tabindex="-1"><a class="header-anchor" href="#启动问题" aria-hidden="true">#</a> 启动问题</h4><p>Spring Boot默认打包方式，将所有依赖文件全部打入项目jar包，我们在启动项目时可以通过</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> xxx.jar
</code></pre></div><p>直接运行。</p><p>而当进行瘦身之后，因为我们已经将项目依赖到外部lib包，我们就不能再通过以上那种方式启动，而是要通过通过-Dloader.path指定lib的路径：</p><div class="language-bash" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> <span class="token parameter variable">-Dloader.path</span><span class="token operator">=</span><span class="token string">&quot;/lib&quot;</span> xxx.jar
</code></pre></div><h4 id="依赖问题" tabindex="-1"><a class="header-anchor" href="#依赖问题" aria-hidden="true">#</a> 依赖问题</h4><p>如果你有一个项目<strong>A</strong>，它依赖于项目<strong>B</strong>，而项目<strong>B</strong>又依赖于项目<strong>C</strong>，那么项目<strong>A</strong>实际上也是依赖于项目<strong>C</strong>的。</p><p>这种情况下，如果使用了<strong>spring-boot-maven-plugin</strong>并配置了<strong>includes</strong>标签，实际上是在设置要包含哪些依赖，而不是要排除哪些依赖。 所以，当你把<strong>B</strong>模块添加到<strong>includes</strong>标签下时，实际上你只是包含了<strong>B</strong>模块本身，而不是它的所有依赖，例如<strong>C</strong>。</p><blockquote><p>当想要<strong>A</strong>也包含<strong>C</strong>的依赖，则需要显示的添加到<strong>includes</strong>标签下</p></blockquote><h4 id="lib包更新问题" tabindex="-1"><a class="header-anchor" href="#lib包更新问题" aria-hidden="true">#</a> lib包更新问题</h4><p>现在项目<strong>A</strong>显示的引入了项目<strong>B</strong>，当项目<strong>C</strong>更新或者添加了新地依赖<strong>D</strong>的时候，项目<strong>A</strong>就需要重新构建以便获取最新版本的 <strong>B</strong>以及其依赖，并且将最新的<strong>lib</strong>包更新到<strong>A</strong>的服务器上。</p>`,30);function d(v,b){return a(),t("div",null,[c,i,u,g,r,p(" more "),k])}const h=s(l,[["render",d],["__file","2306211023.html.vue"]]);export{h as default};
